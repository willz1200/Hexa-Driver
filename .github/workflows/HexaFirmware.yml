# This is the name of the workflow, visible on GitHub UI.
name: Hexa Driver Firmware

# Here we tell GitHub to run the workflow when a commit
# is pushed or a Pull Request is opened.
on: [push, pull_request]

# This is the list of jobs that will be run concurrently.
# Since we use a build matrix, the actual number of jobs
# started depends on how many configurations the matrix
# will produce.
jobs:
  # This is the name of the job - can be whatever.
  Hexa-Matrix:

    # Here we tell GitHub that the jobs must be determined
    # dynamically depending on a matrix configuration.
    strategy:
      matrix:
        # The matrix will produce one job for each configuration
        # parameter of type `arduino-platform`, in this case a
        # total of 1.
        arduino-platform: ["Hexa_Rev_1.0"]

        include:
          - arduino-platform: "Hexa_Rev_1.0"
            fqbn: "Arduino_STM32:STM32F1:mapleMini:bootloader_version=bootloader20,cpu_speed=speed_72mhz,opt=osstd"

    # This is the platform GitHub will use to run our workflow
    runs-on: windows-latest

    # This is the list of steps this job will run.
    steps:
      # Clone the repo using the `checkout` action.
      - name: Checkout
        uses: actions/checkout@v2

      # Configure the Arduino CLI on the system.
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1.0.0

      ###---\/---REMOVED---\/---
      #- name: Create arduino-cli.yaml File
      #  uses: finnp/create-file-action@1.0.0
      #  env: |
      #    FILE_NAME = "arduino-cli.yaml"
      #    FILE_DATA = "board_manager:\n  additional_urls:\n    - https://lemzo.co.uk/Arduino_STM32/package_Arduino_STM32_index.json"
      
      
      #- name: Create arduino-cli.yaml File
      #  run: arduino-cli config init
      
      #- name: Add Line to arduino-cli.yaml
      #  run: |
      #    $file = 'C:\Users\runneradmin\AppData\Local\Arduino15\arduino-cli.yaml'
      #    $find = '  additional_urls: []'
      #    $replace = '  additional_urls: [https://lemzo.co.uk/Arduino_STM32/package_Arduino_STM32_index.json]'
      #    (Get-Content $file).replace($find, $replace) | Set-Content $file
        
      #- name: Directory List
      #  run: dir "C:\Users\runneradmin\AppData\Local\Arduino15\"
      
      #- name: Print arduino-cli.yaml
      #  run: Get-Content -Path C:\Users\runneradmin\AppData\Local\Arduino15\arduino-cli.yaml
      ###---/\---REMOVED---/\---
      
      # Install the STM32F1 package
      - name: Install package config
        run: |
          arduino-cli core update-index --additional-urls https://lemzo.co.uk/Arduino_STM32/package_Arduino_STM32_index.json
          arduino-cli core search Arduino_STM32 --additional-urls https://lemzo.co.uk/Arduino_STM32/package_Arduino_STM32_index.json
      
      # Core index update to pull latest json file from server
      - name: Core Index Update
        run: arduino-cli core update-index

      # Install STM32F1 package using zip found in json file
      - name: Install STM32F1 Platform
        run:
          arduino-cli core install Arduino_STM32:STM32F1

      # Check the STM32F1 package has been installed
      #- name: List Platforms
      #  run: arduino-cli core list

      # Finally, we compile the firmware, using the FQBN that was set
      # in the build matrix.
      - name: Compile Hexa Driver Firmware
        run: arduino-cli compile --fqbn ${{ matrix.fqbn }} ./Firmware/Hexa
